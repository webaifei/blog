{% extends './common/layout.html' %}
{% block title %} {{title}} {% endblock %}
{% block content %}
	<div class="row">
		
		<form class="form-horizontal col-lg-8 col-md-8 col-sm-8 col-lg-offset-2 col-sm-offset-2">
			<div class="form-group">
				<label for="inputEmail3" class="col-sm-2 control-label" >标题</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="title" placeholder="title" value={{post.title}}>
				</div>
			</div>
			<div class="form-group">
				<label for="inputPassword3" class="col-sm-2 control-label">正文</label>
				<div class="col-sm-10">
					<textarea class="form-control" id="content" rows="10" value={{post.content}}>{{post.content}}</textarea>
				</div>

			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10" id="tags">
					{% for item in tagsCol %}
						<label class="checkbox-inline">
						  <input type="checkbox" name="tags" id="type0" value={{loop.key}} 

							{% if post.tags.indexOf(loop.key)!=-1 %}
								checked="" 
							{% endif %}
						  > {{item.name}}
						  {{post.tags.indexOf(loop.key)!=-1}}
						</label>
					{% endfor %}
					
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<a class="btn btn-primary" id="save" data-type={{post._id.toString()}}>发布</a>
					<a class="btn btn-default" id="no-post" data-type={{post._id.toString()}}>保存 暂不发布</a>
				</div>
			</div>
		</form>
	</div>
	<script type="text/javascript" src="/js/layer.js"></script>
	<script type="text/javascript" src="/js/utils.js"></script>
	<script type="text/javascript">
	// variables 
	var saveBtn = $('#save'),
		saveWithoutPostBtn = $('#no-post'),
		title = $('#title'),
		content = $('#content'),
		tagsP = $('#tags'),
		tags = [];

		// 发布文章
		saveBtn.on('click', function (){
			var id = $(this).attr('data-type')
			postArticle(false, id)
			
		})

		saveWithoutPostBtn.on('click', function (){
			var id = $(this).attr('data-type');
			postArticle(true, id);
		})
	/**
	 * 发布文章
	 */
	 function postArticle(hidden, id){
	 	var _title = title.val(),
	 		_content = content.val();
	 		tags = [];
	 		tagsP.find('input[type="checkbox"]:checked').map(function (index,item){
	 			 tags.push($(item).val())
	 		})
	 	
	 	
	 	if( !_title ){
	 		alert('请填写文章标题');
	 		return;
	 	}
	 	if( !_content ){
	 		alert('请输入文章的正文！')
	 		return;
	 	}
	 	if(!tags.length){
	 		alert('请选择文章的标签！')
	 		return;
	 	}
	 	var postData = {
	 		title: _title,
	 		content: _content,
	 		tags: tags,
	 		hidden: hidden
	 	}
	 	id&&(postData._id = id);
	 	var post = new Post(postData)
	 	
	 	post.save(function (res){
	 		if(res.code == 0 && res.data){
	 			window.location.href ='/admin'
	 		}else{
	 			utils.msg(res.msg, 2)
	 		}
	 	})
	 }
	/**
	 * 文章类
	 */
	
	function Post(parmas){
		this.data = parmas;
	}
	// 保存文章
	Post.prototype.save = function (successFn, failFn){
		var data = this.data;
		
		$.ajax({
			url:'http://localhost:3000/api/post',
			type:'POST',
			dataType:'json',
			data: data,
			success:function (res){
				successFn&&successFn(res)
			},
			error: function (err){
				alert(err)
				failFn&&failFn(err)
			}
		})
	}
	//更新文章
	Post.prototype.update = function (successFn, failFn){
		var data = this.data;
		
		$.ajax({
			url:'http://localhost:3000/api/post',
			type:'POST',
			dataType:'json',
			data: data,
			success:function (res){
				successFn&&successFn(res)
			},
			error: function (err){
				alert(err)
				failFn&&failFn(err)
			}
		})
	}
	</script>
{% endblock %}